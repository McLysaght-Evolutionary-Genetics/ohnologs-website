generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["filteredRelationCount"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// TODO: segments
// TODO: microsynteny

enum GenomeCompletnesss {
  chromosome
  scaffold
}

model Species {
  id String @id @default(uuid())

  //
  name        String             @unique
  completness GenomeCompletnesss @default(value: chromosome)
  version     String             @default(value: "")

  //
  source         GenomeSource @relation(fields: [genomeSourceId], references: [id])
  genomeSourceId String

  state         GenomeState @relation(fields: [genomeStateId], references: [id])
  genomeStateId String

  scaffolds   Scaffold[]
  treeSpecies TreeSpecies[]
}

model GenomeSource {
  id String @id @default(uuid())

  //
  name String @unique

  //
  species Species[]
}

model GenomeState {
  id String @id @default(uuid())

  //
  name String @unique

  //
  species Species[]
}

model Scaffold {
  id String @id @default(uuid())

  //
  name  String
  start Int
  end   Int

  //
  species   Species @relation(fields: [speciesId], references: [id])
  speciesId String

  genes    Gene[]
  segments Segment[]

  //
  @@unique([name, speciesId])
}

model Segment {
  id String @id @default(uuid())

  //
  name  String
  start Int
  end   Int

  //
  Scaffold   Scaffold @relation(fields: [scaffoldId], references: [id])
  scaffoldId String
}

model Gene {
  id String @id @default(uuid())

  //
  geneId    String @unique
  proteinId String @unique
  start     Int
  end       Int

  //
  scaffold   Scaffold? @relation(fields: [scaffoldId], references: [id])
  scaffoldId String?

  family   Family? @relation(fields: [familyId], references: [id])
  familyId String?

  labels GeneLabel[]
  trees  TreeGene[]
}

// orthology/paralogy relationships
model Family {
  id String @id @default(uuid())

  //
  index Int @unique

  //
  genes Gene[]
}

// evidence-based labelling
model Label {
  id String @id @default(uuid())

  //
  name String @unique

  //
  genes GeneLabel[]
}

model GeneLabel {
  //
  gene   Gene   @relation(fields: [geneId], references: [id])
  geneId String

  label   Label  @relation(fields: [labelId], references: [id])
  labelId String

  //
  @@id([geneId, labelId])
}

// gene tree viewer
model Tree {
  id String @id @default(uuid())

  //
  newick String

  //
  genes   TreeGene[]
  species TreeSpecies[]
}

model TreeGene {
  //
  tree   Tree   @relation(fields: [treeId], references: [id])
  treeId String

  gene   Gene   @relation(fields: [geneId], references: [id])
  geneId String

  //
  @@id([treeId, geneId])
}

model TreeSpecies {
  //
  tree   Tree   @relation(fields: [treeId], references: [id])
  treeId String

  species   Species @relation(fields: [speciesId], references: [id])
  speciesId String

  //
  @@id([treeId, speciesId])
}
